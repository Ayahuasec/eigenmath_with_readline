trace = 1

-- check sort order

3+4*i
check(infixform(last)="3 + 4 i")
x^2*y
check(infixform(last)="x^2 y")
y*x^2
check(infixform(last)="x^2 y")
x*y^2
check(infixform(last)="x y^2")
y^2*x
check(infixform(last)="x y^2")
(x+1)^2
check(infixform(last)="x^2 + 2 x + 1")
(a+b)^2
check(infixform(last)="a^2 + 2 a b + b^2")
(a+b)^3
check(infixform(last)="a^3 + 3 a^2 b + 3 a b^2 + b^3")
x*cos(x)
check(infixform(last)="x cos(x)")
cos(x)*x
check(infixform(last)="x cos(x)")

-- test add.c

A=((0,0),(0,0))
B=((0,0),(0,0))
A+B
check(infixform(last)="((0,0),(0,0))")

A=2
B=3
check(A-B=-1)
check(B-A=1)
A=-2
B=3
check(A-B=-5)
check(B-A=5)
A=2
B=-3
check(A-B=5)
check(B-A=-5)
A=-2
B=-3
check(A-B=1)
check(B-A=-1)
A=quote(A)
B=quote(B)

-- term sort ignores coeff
check(prefixform(a-b)="(+ a (* -1 b))")
check(prefixform(b-a)="(+ (* -1 a) b)")

-- test multiply.c

N = 2*3^100
M = N/sqrt(2)
check(M^2=N^2/2)
check(infixform(M) = "515377520732011331036461129765621272702107522001 2^(1/2)")
M = sqrt(2)/N
check(M^2=2/N^2)
check(infixform(M) = "1 / (515377520732011331036461129765621272702107522001 2^(1/2))")
M = N/2^(2/3)
check(M^3=N^3/4)
check(infixform(M) = "515377520732011331036461129765621272702107522001 2^(1/3)")
M = 2^(2/3)/N
check(M^3=4/N^3)
check(infixform(M) = "1 / (515377520732011331036461129765621272702107522001 2^(1/3))")

N = -2^10 * 3^10 / 5^10 / 7^10 * x * y
M = 2^(2/3) * 3^(2/3) / 5^(2/3) / 7^(2/3)
check(N/M = -2^(10-2/3) * 3^(10-2/3) / 5^(10-2/3) / 7^(10-2/3) * x * y)
check(N*M = -2^(10+2/3) * 3^(10+2/3) / 5^(10+2/3) / 7^(10+2/3) * x * y)

A = 1.0 * sqrt(2) * sqrt(3) * x * y
B = sqrt(2.0) * sqrt(3.0) * x * y
check(infixform(A) = "2.44949 x y")
check(infixform(B) = "2.44949 x y")

clear

0^a
check(infixform(last)="0^a")

2^(3/2)
check(infixform(last)="2 2^(1/2)")

858/sqrt(2)
check(infixform(last)="429 2^(1/2)")

(-3)^(3/2)
check(infixform(last)="-3 3^(1/2) i")

(10^10)^(4/3)
check(infixform(last)="10000000000 10000000000^(1/3)")

check(exp(i*pi)=-1)
check(prefixform(exp(i*pi+a))="(* -1 (^ $e a))")

6*sqrt(2)*sqrt(3)
check(infixform(last)="6 2^(1/2) 3^(1/2)")

(a+b)*(a+b)
check(infixform(last)="a^2 + 2 a b + b^2")

(a+b)*(a+b)*(a+b)
check(infixform(last)="a^3 + 3 a^2 b + 3 a b^2 + b^3")

1/(a+b)^2
check(infixform(last)="1 / (a + b)^2")

(a+b*i)/(c+d*i)
check(infixform(last)="a / (c + i d) + i b / (c + i d)")

((2+3*i)^2)^(-1)
check(infixform(last)="-5/169 - 12/169 i")

((2+3*i)^(-1))^2
check(infixform(last)="-5/169 - 12/169 i")

s^(-8*pi*i)
check(infixform(last)="s^(-8 i pi)")

e^(-8*pi*i)
check(last=1)

N = 102/2^64
M = sqrt(N)
N - M^2
check(last=0)

N = 2^64/102
M = sqrt(N)
N - M^2
check(last=0)

"Testing imaginary unit"

T = (-1)^(1/2)
check(infixform(T)="i")
T = (-1)^(3/2)
check(infixform(T)="-i")
T = (-1)^(5/2)
check(infixform(T)="i")
T = (-1)^(7/2)
check(infixform(T)="-i")

T = (-1)^(9/2)
check(infixform(T)="i")
T = (-1)^(11/2)
check(infixform(T)="-i")
T = (-1)^(13/2)
check(infixform(T)="i")
T = (-1)^(15/2)
check(infixform(T)="-i")

T = (-1)^(-1/2)
check(infixform(T)="-i")
T = (-1)^(-3/2)
check(infixform(T)="i")
T = (-1)^(-5/2)
check(infixform(T)="-i")
T = (-1)^(-7/2)
check(infixform(T)="i")

T = (-1)^(-9/2)
check(infixform(T)="-i")
T = (-1)^(-11/2)
check(infixform(T)="i")
T = (-1)^(-13/2)
check(infixform(T)="-i")
T = (-1)^(-15/2)
check(infixform(T)="i")

T = (-1)^(1/8)
check(prefixform(T)="(^ -1 1/8)")
T = (-1)^(3/8)
check(prefixform(T)="(^ -1 3/8)")
T = (-1)^(5/8)
check(prefixform(T)="(* -1 (^ -1 -3/8))")
T = (-1)^(7/8)
check(prefixform(T)="(* -1 (^ -1 -1/8))")
T = (-1)^(9/8)
check(prefixform(T)="(* -1 (^ -1 1/8))")
T = (-1)^(11/8)
check(prefixform(T)="(* -1 (^ -1 3/8))")
T = (-1)^(13/8)
check(prefixform(T)="(^ -1 -3/8)")
T = (-1)^(15/8)
check(prefixform(T)="(^ -1 -1/8)")

T = (-1)^(17/8)
check(prefixform(T)="(^ -1 1/8)")
T = (-1)^(19/8)
check(prefixform(T)="(^ -1 3/8)")
T = (-1)^(21/8)
check(prefixform(T)="(* -1 (^ -1 -3/8))")
T = (-1)^(23/8)
check(prefixform(T)="(* -1 (^ -1 -1/8))")
T = (-1)^(25/8)
check(prefixform(T)="(* -1 (^ -1 1/8))")
T = (-1)^(27/8)
check(prefixform(T)="(* -1 (^ -1 3/8))")
T = (-1)^(29/8)
check(prefixform(T)="(^ -1 -3/8)")
T = (-1)^(31/8)
check(prefixform(T)="(^ -1 -1/8)")

T = (-1)^(-1/8)
check(prefixform(T)="(^ -1 -1/8)")
T = (-1)^(-3/8)
check(prefixform(T)="(^ -1 -3/8)")
T = (-1)^(-5/8)
check(prefixform(T)="(* -1 (^ -1 3/8))")
T = (-1)^(-7/8)
check(prefixform(T)="(* -1 (^ -1 1/8))")
T = (-1)^(-9/8)
check(prefixform(T)="(* -1 (^ -1 -1/8))")
T = (-1)^(-11/8)
check(prefixform(T)="(* -1 (^ -1 -3/8))")
T = (-1)^(-13/8)
check(prefixform(T)="(^ -1 3/8)")
T = (-1)^(-15/8)
check(prefixform(T)="(^ -1 1/8)")

T = (-1)^(-17/8)
check(prefixform(T)="(^ -1 -1/8)")
T = (-1)^(-19/8)
check(prefixform(T)="(^ -1 -3/8)")
T = (-1)^(-21/8)
check(prefixform(T)="(* -1 (^ -1 3/8))")
T = (-1)^(-23/8)
check(prefixform(T)="(* -1 (^ -1 1/8))")
T = (-1)^(-25/8)
check(prefixform(T)="(* -1 (^ -1 -1/8))")
T = (-1)^(-27/8)
check(prefixform(T)="(* -1 (^ -1 -3/8))")
T = (-1)^(-29/8)
check(prefixform(T)="(^ -1 3/8)")
T = (-1)^(-31/8)
check(prefixform(T)="(^ -1 1/8)")

-- floating point

T = (-1)^(1/2.0)
check(infixform(T)="i")
T = (-1)^(3/2.0)
check(infixform(T)="-i")
T = (-1)^(5/2.0)
check(infixform(T)="i")
T = (-1)^(7/2.0)
check(infixform(T)="-i")

T = (-1)^(9/2.0)
check(infixform(T)="i")
T = (-1)^(11/2.0)
check(infixform(T)="-i")
T = (-1)^(13/2.0)
check(infixform(T)="i")
T = (-1)^(15/2.0)
check(infixform(T)="-i")

T = (-1)^(-1/2.0)
check(infixform(T)="-i")
T = (-1)^(-3/2.0)
check(infixform(T)="i")
T = (-1)^(-5/2.0)
check(infixform(T)="-i")
T = (-1)^(-7/2.0)
check(infixform(T)="i")

T = (-1)^(-9/2.0)
check(infixform(T)="-i")
T = (-1)^(-11/2.0)
check(infixform(T)="i")
T = (-1)^(-13/2.0)
check(infixform(T)="-i")
T = (-1)^(-15/2.0)
check(infixform(T)="i")

--

clear

(2+3*i)^c
check(infixform(last)="(2 + 3 i)^c")

(a+b)^c
check(infixform(last)="(a + b)^c")

(1+i)^2
check(prefixform(last)="(* 2 (^ -1 1/2))")

(2*i)^2
check(last=-4)

(2+3*i)^2
check(prefixform(last)="(+ -5 (* 12 (^ -1 1/2)))")

(2+3*i)^(-2)
check(prefixform(last)"(+ -5/169 (* -12/169 (^ -1 1/2)))")

(2+3*i)^(1/2)
check(infixform(last)="13^(1/4) (-1)^(arctan(3,2) / (2 pi))")

(2+3*i)^(-1/2)
check(infixform(last)="(-1)^(-arctan(3,2) / (2 pi)) / 13^(1/4)")

i^0
check(last=1)

i^1
check(prefixform(last)="(^ -1 1/2)")

i^2
check(last=-1)

i^3
check(prefixform(last)="(* -1 (^ -1 1/2))")

i^4
check(last=1)

i^5
check(prefixform(last)="(^ -1 1/2)")

i^6
check(last=-1)

i^7
check(prefixform(last)="(* -1 (^ -1 1/2))")

i^(-1)
check(prefixform(last)="(* -1 (^ -1 1/2))")

i^(-2)
check(last=-1)

i^(-3)
check(prefixform(last)="(^ -1 1/2)")

i^(-4)
check(last=1)

i^(-5)
check(prefixform(last)="(* -1 (^ -1 1/2))")

i^(-6)
check(last=-1)

i^(-7)
check(prefixform(last)="(^ -1 1/2)")

sqrt(102)
check(infixform(last)="2^(1/2) 3^(1/2) 17^(1/2)")

sqrt(204)
check(infixform(last)="2 3^(1/2) 17^(1/2)")

sqrt(408)
check(infixform(last)="2 2^(1/2) 3^(1/2) 17^(1/2)")

sqrt(816)
check(infixform(last)="4 3^(1/2) 17^(1/2)")

sqrt(2^32-5)
check(infixform(last)="4294967291^(1/2)")
check(2^32-5=4294967291)

sqrt(2^32-4)
check(infixform(last)="6 7^(1/2) 11^(1/2) 31^(1/2) 151^(1/2) 331^(1/2)")
check(2^32-4=36*7*11*31*151*331)

sqrt(2^32-3)
check(infixform(last)="9241^(1/2) 464773^(1/2)")
check(2^32-3=9241*464773)

sqrt(2^32-2)
check(infixform(last)="2^(1/2) 2147483647^(1/2)")
check(2^32-2=2*2147483647)

sqrt(2^32-1)
check(infixform(last)="3^(1/2) 5^(1/2) 17^(1/2) 257^(1/2) 65537^(1/2)")
check(2^32-1=3*5*17*257*65537)

for(k,1,100,
N=2^32-k,
M=sqrt(N),
check(N/M=M))

A = ((A11,A12),(A21,A22))
simplify(dot(A,inv(A)))
check(last=unit(2))

A = ((A11,A12,A13),(A21,A22,A23),(A31,A32,A33))
simplify(dot(A,inv(A)))
check(last=unit(3))

A = ((A11,A12,A13,A14),(A21,A22,A23,A24),(A31,A32,A33,A34),(A41,A42,A43,A44))
simplify(dot(A,inv(A)))
check(last=unit(4))

A = (A1,A2,A3)
B = (B1,B2,B3,B4)
C = (C1,C2,C3,C4,C5)
D = (D1,D2,D3,D4,D5)
E = (E1,E2,E3,E4,E5,E6)
F = (F1,F2,F3,F4,F5,F6,F7)

G = dot(outer(A,B,C),outer(D,E,F))
H = contract(outer(A,B,C,D,E,F),3,4)
check(G=H)

G = transpose(outer(A,B,C,D,E,F))
H = outer(B,A,C,D,E,F)
check(G=H)

G = transpose(outer(A,B,C,D,E,F),1,2)
H = outer(B,A,C,D,E,F)
check(G=H)

G = transpose(outer(A,B,C,D,E,F),1,3)
H = outer(C,B,A,D,E,F)
check(G=H)

G = transpose(outer(A,B,C,D,E,F),1,4)
H = outer(D,B,C,A,E,F)
check(G=H)

G = transpose(outer(A,B,C,D,E,F),1,5)
H = outer(E,B,C,D,A,F)
check(G=H)

G = transpose(outer(A,B,C,D,E,F),1,6)
H = outer(F,B,C,D,E,A)
check(G=H)

G = transpose(outer(A,B,C,D,E,F),2,3)
H = outer(A,C,B,D,E,F)
check(G=H)

G = transpose(outer(A,B,C,D,E,F),2,4)
H = outer(A,D,C,B,E,F)
check(G=H)

G = transpose(outer(A,B,C,D,E,F),2,5)
H = outer(A,E,C,D,B,F)
check(G=H)

G = transpose(outer(A,B,C,D,E,F),2,6)
H = outer(A,F,C,D,E,B)
check(G=H)

G = transpose(outer(A,B,C,D,E,F),3,4)
H = outer(A,B,D,C,E,F)
check(G=H)

G = transpose(outer(A,B,C,D,E,F),3,5)
H = outer(A,B,E,D,C,F)
check(G=H)

G = transpose(outer(A,B,C,D,E,F),3,6)
H = outer(A,B,F,D,E,C)
check(G=H)

G = transpose(outer(A,B,C,D,E,F),4,5)
H = outer(A,B,C,E,D,F)
check(G=H)

G = transpose(outer(A,B,C,D,E,F),4,6)
H = outer(A,B,C,F,E,D)
check(G=H)

G = transpose(outer(A,B,C,D,E,F),5,6)
H = outer(A,B,C,D,F,E)
check(G=H)

A = (A1,A2,A3)
B = (B1,B2,B3)
check(contract(outer(A,B))=dot(A,B))

A = (A1,A2,A3,A4)
B = (B1,B2,B3)
C = (C1,C2,C3)
check(contract(outer(A,B,C),2,3)=dot(B,C)*A)

A = (A1,A2,A3)
B = (B1,B2,B3)
C = (C1,C2,C3,C4)
check(contract(outer(A,B,C))=dot(A,B)*C)

-- test simplify

clear

simplify(-3*x*A/(A-B) + 3*x*B/(A-B))
check(infixform(last)="-3 x")

simplify(-y/(x^2*(y^2/x^2+1)))
check(infixform(last) = "-y / (x^2 + y^2)")

simplify(1/(x*(y^2/x^2+1)))
check(infixform(last) = "x / (x^2 + y^2)")

simplify(-i * exp(i * x) / (2 * (1/2 * exp(i * x) + 1/2 * exp(-i * x))))
check(infixform(last) = "-i exp(2 i x) / (exp(2 i x) + 1)")

simplify(i * exp(-i * x) / (2 * (1/2 * exp(i * x) + 1/2 * exp(-i * x))))
check(infixform(last) = "i / (exp(2 i x) + 1)")

simplify(tan(x) - sin(x)/cos(x))
check(infixform(last) = "0")

simplify(sin(x)^2 + cos(x)^2)
check(infixform(last) = "1")

simplify(sinh(x)^2 - cosh(x)^2)
check(infixform(last) = "-1")

simplify(((sin(x)^2 + cos(x)^2,0),(0,sin(x))))
check(last = ((1,0),(0,sin(x))))

-- numerator and denominator had an infinite loop
numerator(-(-i + i * exp(2 * i * x)) / (exp(2 * i * x) + 1))
check(last=i - i * exp(2 * i * x))
denominator(-(-i + i * exp(2 * i * x)) / (exp(2 * i * x) + 1))
check(last=exp(2 * i * x) + 1)

check(exptan(z)=(exp(2*i*z)-1)/(i*(exp(2*i*z)+1)))
check(circexp(expsin(z)/expcos(z)-exptan(z))=0)

2 * M / (-2 * M * r^2 + r^3) + r^(-2) - 1 / (-2 * M * r + r^2)
simplify
check(last=0)

2 * M / (-2 * M * r^2 + r^3) + r^(-2) - 1 / (-2 * M * r + r^2) + 1
rationalize
check(last = (4 * M^2 * r^3 - 4 * M * r^4 + r^5) / ((-2 * M * r + r^2) * (-2 * M * r^2 + r^3)))
simplify
check(last = 1)

check(simplify(sqrt(1 + x^2 / (1 - x^2))) == 1 / sqrt(1 - x^2))

-- test arctan

check(infixform(arctan(0,0))="arctan(0,0)")

check(infixform(arctan(x))="arctan(x,1)")

check(arctan(1,1)=pi/4)
check(arctan(1,-1)=3*pi/4)
check(arctan(-1,1)=-pi/4)
check(arctan(-1,-1)=-3*pi/4)

check(arctan(0,3)=0)
check(arctan(0,-3)=-pi)
check(arctan(3,0)=pi/2)
check(arctan(-3,0)=-pi/2)

check(arctan(3,3)=pi/4)
check(arctan(3,-3)=3*pi/4)
check(arctan(-3,3)=-pi/4)
check(arctan(-3,-3)=-3*pi/4)

check(infixform(arctan(2,4))="arctan(1,2)")
check(infixform(arctan(2,-4))="arctan(1,-2)")
check(infixform(arctan(-2,4))="arctan(-1,2)")
check(infixform(arctan(-2,-4))="arctan(-1,-2)")

check(infixform(arctan(1/2))="arctan(1,2)")

-- complex numbers (after arctan)

z1 = 1+i     -- z1 does not have arctan in polar form
z2 = 2+3*i   -- z2 does have arctan in polar form

check(arg(z1)=pi/4)
check(mag(z1)=sqrt(2))

check(arg(z2)=arctan(3,2))
check(mag(z2)=sqrt(13))

check(arg(polar(z1))=pi/4)
check(arg(clock(z1))=pi/4)

check(arg(polar(z2))=arctan(3,2))
check(arg(clock(z2))=arctan(3,2))

check(mag(polar(z1))=sqrt(2))
check(mag(clock(z1))=sqrt(2))

check(mag(polar(z2))=sqrt(13))
check(mag(clock(z2))=sqrt(13))

check(z1*z2=rect(clock(z1)*clock(z2)))
check(z1*z2=rect(clock(z1)*polar(z2)))
check(z1*z2=rect(polar(z1)*clock(z2)))
check(z1*z2=rect(polar(z1)*polar(z2)))

z = sqrt(1+i)
check(rect(z^2)=1+i)
z = sqrt(1-i)
check(rect(z^2)=1-i)
z = sqrt(-1+i)
check(rect(z^2)=-1+i)
z = sqrt(-1-i)
check(rect(z^2)=-1-i)

z = sqrt(2+3*i)
check(rect(z^2)=2+3*i)
z = sqrt(2-3*i)
check(rect(z^2)=2-3*i)
z = sqrt(-2+3*i)
check(rect(z^2)=-2+3*i)
z = sqrt(-2-3*i)
check(rect(z^2)=-2-3*i)

z1 = sqrt(2+3*i)
z2 = sqrt(4+5*i)
check(sqrt(z1*z2)=sqrt(z1)*sqrt(z2))
check(sqrt(z1/z2)=sqrt(z1)/sqrt(z2))

z1 = 1+i     -- z1 does not have arctan
z2 = 2+3*i   -- z2 does have arctan
check(z1*z2=rect(clock(z1)*clock(z2)))
check(z1*z2=rect(polar(z1)*polar(z2)))

check(arg(z1)=pi/4)
check(arg(polar(z1))=pi/4)
check(arg(clock(z1))=pi/4)

check(arg(z2)=arctan(3,2))
check(arg(polar(z2))=arctan(3,2))
check(arg(clock(z2))=arctan(3,2))

check(mag(z1)=sqrt(2))
check(mag(polar(z1))=sqrt(2))
check(mag(clock(z1))=sqrt(2))

check(mag(z2)=sqrt(13))
check(mag(polar(z2))=sqrt(13))
check(mag(clock(z2))=sqrt(13))

clock(2+3*i) - clock(2+3*i)
check(last=0)

-- test float

float(x + pi)
check(infixform(last)="x + 3.14159")
float(x + e)
check(infixform(last)="x + 2.71828")
float(x + y + 1/4)
check(infixform(last)="x + y + 0.25")
float(1/4 x y)
check(infixform(last)="0.25 x y")
float(sqrt(2))
check(infixform(last)="1.41421")

mag(1.0 + 3 i)
check(infixform(last)="3.16228")
real(1.0 + 3 i)
check(infixform(last)="1")
imag(1.0 i)
check(infixform(last)="1")
imag(-1.0 i)
check(infixform(last)="-1")

-- test log of zero

log(0)
check(infixform(last)="log(0)")

-- test log of complex number

log(1 + i)
check(infixform(last)="log(1 + i)")

float(log(1 + i))
check(infixform(last)="0.346574 + 0.785398 i")

log(0.5)
check(infixform(last)="-0.693147")

log(-0.5)
check(infixform(last)="-0.693147 + 3.14159 i")

--log(1.0 i)
--check(infixform(last)="1.5708 i")

--log(-1.0 i)
--check(infixform(last)="-1.5708 i")

-- check arg function

arg(-1)
check(prefixform(last)="(* -1 pi)")

arg(-1.0)
check(prefixform(last)="-3.14159")

-- check arccosh

prefixform(arccosh(x))
check(last="(arccosh x)")

prefixform(arccosh(cosh(x)))
check(last="x")

prefixform(arccosh(0))
check(last="(arccosh 0)")

prefixform(arccosh(1))
check(last="0")

prefixform(arccosh(1.0))
check(last="0")

prefixform(arccosh(-1))
check(last="(arccosh -1)")

prefixform(arccosh(-1.0))
check(last="(* 3.14159 (^ -1 1/2))")

prefixform(float(arccosh(1+i)))
check(last="(+ 1.06128 (* 0.904557 (^ -1 1/2)))")

-- check arcsinh

prefixform(arcsinh(x))
check(last="(arcsinh x)")

prefixform(arcsinh(sinh(x)))
check(last="x")

prefixform(arcsinh(0))
check(last="0")

prefixform(arcsinh(1))
check(last="(arcsinh 1)")

prefixform(arcsinh(1.0))
check(last="0.881374")

prefixform(arcsinh(-1))
check(last="(* -1 (arcsinh 1))")

prefixform(arcsinh(-1.0))
check(last="-0.881374")

prefixform(float(arcsinh(1+i)))
check(last="(+ 1.06128 (* 0.666239 (^ -1 1/2)))")

-- check arctanh

prefixform(arctanh(x))
check(last="(arctanh x)")

prefixform(arctanh(tanh(x)))
check(last="x")

prefixform(arctanh(0))
check(last="0")

prefixform(arctanh(1))
check(last="(arctanh 1)")

prefixform(arctanh(-1))
check(last="(arctanh -1)")

prefixform(arctanh(0.5))
check(last="0.549306")

prefixform(arctanh(-0.5))
check(last="-0.549306")

prefixform(float(arctanh(1+i)))
check(last="(+ 0.402359 (* 1.01722 (^ -1 1/2)))")

-- check exp

prefixform(float(exp(x)))
check(last="(^ $e x)")

prefixform(exp(0))
check(last="1")

prefixform(exp(1))
check(last="$e")

prefixform(exp(1.0))
check(last="2.71828")

prefixform(e^1.0)
check(last="2.71828")

prefixform(exp(2.0))
check(last="7.38906")

prefixform(e^2.0)
check(last="7.38906")

prefixform(float(e))
check(last="2.71828")

-- check power

prefixform(0^0)
check(last="1")

((1,2),(3,4))^0
check(infixform(last)="((1,0),(0,1))")

((1,2),(3,4))^1
check(infixform(last)="((1,2),(3,4))")

-- test sin function

float(sin(1+i))
check(infixform(last)="1.29846 + 0.634964 i")

-- test cos function

float(cos(1+i))
check(infixform(last)="0.83373 - 0.988898 i")

-- test tan function

float(tan(1+i))
check(infixform(last)="0.271753 + 1.08392 i")

-- test sinh function

float(sinh(1+i))
check(infixform(last)="0.634964 + 1.29846 i")

-- test cosh function

float(cosh(1+i))
check(infixform(last)="0.83373 + 0.988898 i")

-- test tanh function

float(tanh(1+i))
check(infixform(last)="1.08392 + 0.271753 i")

-- test arcsin function

float(arcsin(1+i))
check(infixform(last)="0.666239 + 1.06128 i")

-- test arccos function

float(arccos(1+i))
check(infixform(last)="0.904557 - 1.06128 i")

-- test arctan function

float(arctan(1+i))
check(infixform(last)="1.01722 + 0.402359 i")

-- test rationalize function (this used to get stuck)

clear

s = 4 E^2
t = -2 E^2 + E^2 exp(i theta) + E^2 exp(-i theta)
u = -2 E^2 - E^2 exp(i theta) - E^2 exp(-i theta)

A = (s^2 + u^2)/t^2
B = 2 s^2/(t u)
C = (s^2 + t^2)/u^2

X = (1 + expcos(theta/2)^4) / expsin(theta/2)^4
Y = 8 / expsin(theta)^2
Z = (1 + expsin(theta/2)^4) / expcos(theta/2)^4

check(rationalize(A + B + C - X - Y - Z) == 0)

f = 1/x + 1/(x + 1)^2
check(infixform(rationalize(f)) == "(x^2 + 3 x + 1) / (x (x + 1)^2)")

-- this was broken, returned a complex number

arccos(0.4529)
check(infixform(last)="1.10078")

-- this was broken, now fixed

expand((x^2+5*x+2)/(2*(x+1)),x)
check(infixform(last) == "1/2 x - 1 / (x + 1) + 2")

f = x / 2 / (x + 1)
expand(f)
check(rationalize(last) == f)

f = x / 2 / (x + 1) / (x + 2)
expand(f)
check(rationalize(last) == f)

f = x / 2 / (x + 1) / (x + 2) / (x + 3)
expand(f)
check(rationalize(last) == f)

-- exponentials are expanded

clear
psi = exp(i k z - i omega t)
1/psi
check(prefixform(last)=="(^ $e (+ (* -1 (^ -1 1/2) k z) (* (^ -1 1/2) omega t)))")
psi^(-1)
check(prefixform(last)=="(^ $e (+ (* -1 (^ -1 1/2) k z) (* (^ -1 1/2) omega t)))")
psi/psi
check(prefixform(last)=="1")

-- loop indices are not rewritten

A = zero(3)
f(x) = for(i,1,3,A[i] = x)
f(1)
check(A==(1,1,1))

-- this was broken, now fixed

clear

z = sqrt(i)
z conj(z)
check(last == 1)

z = (-1)^a
z conj(z)
check(last == 1)

-- tensor comparison

(0,0) == (0,0,0) -- both are equal to scalar zero
check(last = 1)

(1,0) == (1,0,0) -- should not cause a stop like (1,0) - (1,0,0) does
check(last = 0)

-- cofactor

A = ((a11,a12),(a21,a22))
B = A
for(i,1,2,for(j,1,2,B[i,j] = cofactor(A,i,j)))
check(B = transpose(adj(A)))

A = ((a11,a12,a13),(a21,a22,a23),(a31,a32,a33))
B = A
for(i,1,3,for(j,1,3,B[i,j] = cofactor(A,i,j)))
check(B = transpose(adj(A)))

-- best rational approximation

x = quote(x)

for(a,-10,10,
 for(b,1,10,
  check(factor(1.0 a/b x) = a/b x)
))

-- mod

-- uses fmod for test reference
for(a,-20,20,for(b,-20,20,test(b = 0,b = 1),check(mod(a/4,b/4) = mod(a/4.0,b/4.0))))

-- tensor promotion

clear

a = quote(a)
b = quote(b)
c = quote(c)
d = quote(d)

A = ((a,b),(c,d))

a = (11,12,13)
b = (21,22,23)
c = (31,32,33)
d = (41,42,43)

B = A

check(B[1,1] = a)
check(B[1,2] = b)
check(B[2,1] = c)
check(B[2,2] = d)

-- verify that defint works in a denominator

clear

I(y) = defint((1 + cos(theta)^2) sin(theta),theta,0,y)
I(theta) / I(pi)
check(last = -1/8 cos(theta)^3 - 3/8 cos(theta) + 1/2)

-- log of number is factored

check(log(1/10) = -log(2) - log(5))

-- factor rational numbers

prefixform(factor(10))
check(last = "(* 2 5)")

prefixform(factor(-10))
check(last = "(* -1 2 5)")

prefixform(factor(1/10))
check(last = "(* (^ 2 -1) (^ 5 -1))")

prefixform(factor(-1/10))
check(last = "(* -1 (^ 2 -1) (^ 5 -1))")

-- factor floating point

for(i,-10,10,for(j,1,100,check(eval(factor(float(i / j))) == i / j)))

prefixform(factor(2^53 - 1))
check(last = "(* 6361 69431 20394401)")

prefixform(factor(float(2^53 - 1)))
check(last = "(* 6361 69431 20394401)")

prefixform(factor(2^53))
check(last = "(^ 2 53)")

prefixform(factor(float(2^53)))
check(last = "(^ 2 53)")

prefixform(factor(2^53 + 1))
check(last = "(* 3 107 28059810762433)")

-- 2^53 + 1 is the smallest positive integer that cannot be represented exactly as a double

prefixform(factor(float(2^53 + 1)))
check(last = "(^ 2 53)")

-- simplify polar

check(exp(-12/2 i pi) == 1)
check(exp(-11/2 i pi) == i)
check(exp(-10/2 i pi) == -1)
check(exp(-9/2 i pi) == -i)

check(exp(-8/2 i pi) == 1)
check(exp(-7/2 i pi) == i)
check(exp(-6/2 i pi) == -1)
check(exp(-5/2 i pi) == -i)

check(exp(-4/2 i pi) == 1)
check(exp(-3/2 i pi) == i)
check(exp(-2/2 i pi) == -1)
check(exp(-1/2 i pi) == -i)

check(exp(0/2 i pi) == 1)
check(exp(1/2 i pi) == i)
check(exp(2/2 i pi) == -1)
check(exp(3/2 i pi) == -i)

check(exp(4/2 i pi) == 1)
check(exp(5/2 i pi) == i)
check(exp(6/2 i pi) == -1)
check(exp(7/2 i pi) == -i)

check(exp(8/2 i pi) == 1)
check(exp(9/2 i pi) == i)
check(exp(10/2 i pi) == -1)
check(exp(11/2 i pi) == -i)

check(exp(-12/2.0 i pi) == 1)
check(exp(-11/2.0 i pi) == i)
check(exp(-10/2.0 i pi) == -1)
check(exp(-9/2.0 i pi) == -i)

check(exp(-8/2.0 i pi) == 1)
check(exp(-7/2.0 i pi) == i)
check(exp(-6/2.0 i pi) == -1)
check(exp(-5/2.0 i pi) == -i)

check(exp(-4/2.0 i pi) == 1)
check(exp(-3/2.0 i pi) == i)
check(exp(-2/2.0 i pi) == -1)
check(exp(-1/2.0 i pi) == -i)

check(exp(0/2.0 i pi) == 1)
check(exp(1/2.0 i pi) == i)
check(exp(2/2.0 i pi) == -1)
check(exp(3/2.0 i pi) == -i)

check(exp(4/2.0 i pi) == 1)
check(exp(5/2.0 i pi) == i)
check(exp(6/2.0 i pi) == -1)
check(exp(7/2.0 i pi) == -i)

check(exp(8/2.0 i pi) == 1)
check(exp(9/2.0 i pi) == i)
check(exp(10/2.0 i pi) == -1)
check(exp(11/2.0 i pi) == -i)

-- cross product test for equality

clear

P(x,l,m) = 1 / (2^l l!) (1 - x^2)^(m / 2) d((x^2 - 1)^l,x,l + m)

check(P(x,0,0) == 1)
check(P(x,1,0) == x)
check(P(x,1,1) == sqrt(1 - x^2))
check(P(x,1,-1) == -1/2 sqrt(1 - x^2))
check(P(x,2,0) == 1/2 (3 x^2 - 1))
check(P(x,2,1) == 3 x sqrt(1 - x^2))
check(P(x,2,-1) == -1/2 x sqrt(1 - x^2))
check(P(x,2,2) == 3 (1 - x^2))
check(P(x,2,-2) == 1/8 (1 - x^2))

-- tensor equality test

clear

A = ((0,0,0,0),(0,2 M / (r^3 (-2 M / r + 1)) + r^(-2) - 1 / (r^2 (-2 M / r + 1)),0,0),(0,0,0,0),(0,0,0,0))
check(A == 0)
check(0 == A)
check(A == zero(4,4))
check(zero(4,4) == A)
B = A
check(A == B)
B[1,1] = 1
check(not(A == B))

-- test legendre function

clear

P(x,l,m) = eval(1/(2^l l!) (1 - y^2)^(m/2) d((y^2 - 1)^l,y,l + m),y,x)

check(legendre(x,0,0) == 1)
check(legendre(x,1,0) == x)
check(legendre(x,1,1) == sqrt(1 - x^2))
check(legendre(x,1,-1) == -1/2 sqrt(1 - x^2))
check(legendre(x,2,0) == 1/2 (3 x^2 - 1))
check(legendre(x,2,1) == 3 x sqrt(1 - x^2))
check(legendre(x,2,-1) == -1/2 x sqrt(1 - x^2))
check(legendre(x,2,2) == 3 (1 - x^2))
check(legendre(x,2,-2) == 1/8 (1 - x^2))

check(P(x,0,0) == legendre(x,0,0))
check(P(x,1,0) == legendre(x,1,0))
check(P(x,1,1) == legendre(x,1,1))
check(P(x,1,-1) == legendre(x,1,-1))
check(P(x,2,0) == legendre(x,2,0))
check(P(x,2,1) == legendre(x,2,1))
check(P(x,2,2) == legendre(x,2,2))
check(P(x,2,-1) == legendre(x,2,-1))
check(P(x,2,-2) == legendre(x,2,-2))

check(P(expcos(theta),0,0) == legendre(expcos(theta),0,0))
check(P(expcos(theta),1,0) == legendre(expcos(theta),1,0))
check(P(expcos(theta),1,1) == legendre(expcos(theta),1,1))
check(P(expcos(theta),1,-1) == legendre(expcos(theta),1,-1))
check(P(expcos(theta),2,0) == legendre(expcos(theta),2,0))
check(P(expcos(theta),2,1) == legendre(expcos(theta),2,1))
check(P(expcos(theta),2,2) == legendre(expcos(theta),2,2))
check(P(expcos(theta),2,-1) == legendre(expcos(theta),2,-1))
check(P(expcos(theta),2,-2) == legendre(expcos(theta),2,-2))

-- test laguerre function

clear

L(x,m,j) = sum(k,0,m,(-x)^k (m + j)! / ((m - k)! (j + k)! k!))

check(L(x,1,0) == laguerre(x,1,0))
check(L(x,2,0) == laguerre(x,2,0))
check(L(x,2,1) == laguerre(x,2,1))
check(L(x,3,0) == laguerre(x,3,0))
check(L(x,3,1) == laguerre(x,3,1))
check(L(x,3,2) == laguerre(x,3,2))

-- moore-penrose inverse of vector

A = (1,2)
check(inv(dot(transpose(A),A)) == 1/5)

-- set component

clear
I = ((1,1,1,1),(1,1,1,1))
A = (I,I,I)
A[1] = a I
A[2] = b I
A[3] = c I
check(A == (((a,a,a,a),(a,a,a,a)),((b,b,b,b),(b,b,b,b)),((c,c,c,c),(c,c,c,c))))

-- 2.7 surface area

clear
M1 = ((0,0,0),(0,0,-1),(0,1,0))
M2 = ((0,0,1),(0,0,0),(-1,0,0))
M3 = ((0,-1,0),(1,0,0),(0,0,0))
M = (M1,M2,M3)
cross(u,v) = dot(u,M,v)
z=2
S = (x,y,z)
a = abs(cross(d(S,x),d(S,y)))
defint(a,y,-sqrt(1 - x^2),sqrt(1 - x^2),x,-1,1)
check(last = pi)

clear
M1 = ((0,0,0),(0,0,-1),(0,1,0))
M2 = ((0,0,1),(0,0,0),(-1,0,0))
M3 = ((0,-1,0),(1,0,0),(0,0,0))
M = (M1,M2,M3)
cross(u,v) = dot(u,M,v)
z = x^2 + 2y
S = (x,y,z)
a = abs(cross(d(S,x),d(S,y)))
defint(a,x,0,1,y,0,1)
check(last = 5/8 log(5) + 3/2)

clear
M1 = ((0,0,0),(0,0,-1),(0,1,0))
M2 = ((0,0,1),(0,0,0),(-1,0,0))
M3 = ((0,-1,0),(1,0,0),(0,0,0))
M = (M1,M2,M3)
cross(u,v) = dot(u,M,v)
x = u cos(v)
y = u sin(v)
z = v
S = (x,y,z)
a = circexp(abs(cross(d(S,u),d(S,v))))
defint(a,u,0,1,v,0,3pi)
check(last = 3/2 pi log(1 + sqrt(2)) + 3 pi / sqrt(2))

-- 2.8 surface integrals

clear
M1 = ((0,0,0),(0,0,-1),(0,1,0))
M2 = ((0,0,1),(0,0,0),(-1,0,0))
M3 = ((0,-1,0),(1,0,0),(0,0,0))
M = (M1,M2,M3)
cross(u,v) = dot(u,M,v)
z = 1 - x^2 - y^2
F = (x y^2 z,-2 x^3,y z^2)
S = (x,y,z)
f = dot(F,cross(d(S,x),d(S,y)))
h = sqrt(1 - x^2)
defint(f,y,-h,h,x,-1,1)
check(last = 1/48 pi)

-- 2.9 green's theorem

clear
P = 2x^3 - y^3
Q = x^3 + y^3
f = d(Q,x) - d(P,y)
x = r cos(theta)
y = r sin(theta)
defint(f r,r,0,1,theta,0,2pi)
check(last = 3/2 pi)

clear
x = cos(t)
y = sin(t)
P = 2x^3 - y^3
Q = x^3 + y^3
f = P d(x,t) + Q d(y,t)
f = circexp(f)
defint(f,t,0,2pi)
check(last = 3/2 pi)

clear
P = 1 - y
Q = x
x = 2 cos(t)
y = 2 sin(t)
defint(P d(x,t) + Q d(y,t),t,0,2pi)
check(last = 8 pi)

x = quote(x) --clear x
y = quote(y) --clear y
h = sqrt(4 - x^2)
defint(d(Q,x) - d(P,y),y,-h,h,x,-2,2)
check(last = 8 pi)

f = d(Q,x) - d(P,y) -- do before change of coordinates
x = r cos(theta)
y = r sin(theta)
defint(f r,r,0,2,theta,0,2pi)
check(last = 8 pi)

defint(f r,theta,0,2pi,r,0,2) -- try integrating over theta first

-- 2.10 stokes' theorem

clear
M1 = ((0,0,0),(0,0,-1),(0,1,0))
M2 = ((0,0,1),(0,0,0),(-1,0,0))
M3 = ((0,-1,0),(1,0,0),(0,0,0))
M = (M1,M2,M3)
cross(u,v) = dot(u,M,v)
"Surface integral"
z = 4 - x^2 - y^2
F = (y,z,x)
S = (x,y,z)
f = dot(curl(F),cross(d(S,x),d(S,y)))
x = r cos(theta)
y = r sin(theta)
defint(f r,r,0,2,theta,0,2pi)
check(last = -4pi)
"Line integral"
x = 2 cos(t)
y = 2 sin(t)
z = 4 - x^2 - y^2
P = y
Q = z
R = x
f = P d(x,t) + Q d(y,t) + R d(z,t)
f = circexp(f)
defint(f,t,0,2pi)
check(last = -4pi)

trace = 0

"Testing minormatrix"

clear

A = ((1,2),
     (3,4))

check(minormatrix(A,1,1) == 4)
check(minormatrix(A,1,2) == 3)

check(minormatrix(A,2,1) == 2)
check(minormatrix(A,2,2) == 1)

A = ((1,2,3),
     (4,5,6))

check(minormatrix(A,1,1) == (5,6))
check(minormatrix(A,1,2) == (4,6))
check(minormatrix(A,1,3) == (4,5))

check(minormatrix(A,2,1) == (2,3))
check(minormatrix(A,2,2) == (1,3))
check(minormatrix(A,2,3) == (1,2))

A = ((1,2),
     (3,4),
     (5,6))

check(minormatrix(A,1,1) == (4,6))
check(minormatrix(A,1,2) == (3,5))

check(minormatrix(A,2,1) == (2,6))
check(minormatrix(A,2,2) == (1,5))

check(minormatrix(A,3,1) == (2,4))
check(minormatrix(A,3,2) == (1,3))

A = ((1,2,3),
     (4,5,6),
     (7,8,9))

check(minormatrix(A,1,1) == ((5,6),(8,9)))
check(minormatrix(A,1,2) == ((4,6),(7,9)))
check(minormatrix(A,1,3) == ((4,5),(7,8)))

check(minormatrix(A,2,1) == ((2,3),(8,9)))
check(minormatrix(A,2,2) == ((1,3),(7,9)))
check(minormatrix(A,2,3) == ((1,2),(7,8)))

check(minormatrix(A,3,1) == ((2,3),(5,6)))
check(minormatrix(A,3,2) == ((1,3),(4,6)))
check(minormatrix(A,3,3) == ((1,2),(4,5)))

A = ((A11,A12,A13),(A21,A22,A23),(A31,A32,A33))
B = ((0,0,0),(0,0,0),(0,0,0))
for(i,1,3,for(j,1,3,B[j,i] = (-1)^(i + j) minor(A,i,j)))
check(B == adj(A))

"Testing cofactor"

clear

A = ((A11,A12),(A21,A22))
B = ((0,0),(0,0))
for(i,1,2,for(j,1,2,B[j,i] = cofactor(A,i,j)))
check(adj(A) == B)

A = ((A11,A12,A13),(A21,A22,A23),(A31,A32,A33))
B = ((0,0,0),(0,0,0),(0,0,0))
for(i,1,3,for(j,1,3,B[j,i] = cofactor(A,i,j)))
check(adj(A) == B)

"Testing kronecker"

clear

A = (2,3)
B = (a,b,c)
check(kronecker(A,B) == (2a,2b,2c,3a,3b,3c))
check(kronecker(B,A) == (2a,3a,2b,3b,2c,3c))

A = (a,b)
B = ((2,3,4),(5,6,7),(8,9,10),(11,12,13))

C = ((2a,3a,4a),
     (5a,6a,7a),
     (8a,9a,10a),
     (11a,12a,13a),
     (2b,3b,4b),
     (5b,6b,7b),
     (8b,9b,10b),
     (11b,12b,13b))

check(kronecker(A,B) == C)

C = ((2a,3a,4a),
     (2b,3b,4b),
     (5a,6a,7a),
     (5b,6b,7b),
     (8a,9a,10a),
     (8b,9b,10b),
     (11a,12a,13a),
     (11b,12b,13b))

check(kronecker(B,A) == C)

A = ((2,3),(4,5))
B = ((a,b),(c,d))

C = ((2a,2b,3a,3b),
     (2c,2d,3c,3d),
     (4a,4b,5a,5b),
     (4c,4d,5c,5d))

check(kronecker(A,B) == C)

"Testing det"

clear
A = ((A11,A12),(A21,A22))
B = A11 A22 - A12 A21
check(det(A) == B)
A = ((A11,A12,A13),(A21,A22,A23),(A31,A32,A33))
B = A11 A22 A33 - A11 A23 A32 - A12 A21 A33 + A12 A23 A31 + A13 A21 A32 - A13 A22 A31
check(det(A) == B)
A = ((A11,A12,A13,A14),(A21,A22,A23,A24),(A31,A32,A33,A34),(A41,A42,A43,A44))
B = A11 A22 A33 A44 -
    A11 A22 A34 A43 -
    A11 A23 A32 A44 +
    A11 A23 A34 A42 +
    A11 A24 A32 A43 -
    A11 A24 A33 A42 -
    A12 A21 A33 A44 +
    A12 A21 A34 A43 +
    A12 A23 A31 A44 -
    A12 A23 A34 A41 -
    A12 A24 A31 A43 +
    A12 A24 A33 A41 +
    A13 A21 A32 A44 -
    A13 A21 A34 A42 -
    A13 A22 A31 A44 +
    A13 A22 A34 A41 +
    A13 A24 A31 A42 -
    A13 A24 A32 A41 -
    A14 A21 A32 A43 +
    A14 A21 A33 A42 +
    A14 A22 A31 A43 -
    A14 A22 A33 A41 -
    A14 A23 A31 A42 +
    A14 A23 A32 A41
check(det(A) == B)
A = ((A11,A12,A13,A14,A15),
     (A21,A22,A23,A24,A25),
     (A31,A32,A33,A34,A35),
     (A41,A42,A43,A44,A45),
     (A51,A52,A53,A54,A55))
B = A11 A22 A33 A44 A55 - A11 A22 A33 A45 A54 - A11 A22 A34 A43 A55 + A11 A22 A34 A45 A53 + A11 A22 A35 A43 A54 -
    A11 A22 A35 A44 A53 - A11 A23 A32 A44 A55 + A11 A23 A32 A45 A54 + A11 A23 A34 A42 A55 - A11 A23 A34 A45 A52 -
    A11 A23 A35 A42 A54 + A11 A23 A35 A44 A52 + A11 A24 A32 A43 A55 - A11 A24 A32 A45 A53 - A11 A24 A33 A42 A55 +
    A11 A24 A33 A45 A52 + A11 A24 A35 A42 A53 - A11 A24 A35 A43 A52 - A11 A25 A32 A43 A54 + A11 A25 A32 A44 A53 +
    A11 A25 A33 A42 A54 - A11 A25 A33 A44 A52 - A11 A25 A34 A42 A53 + A11 A25 A34 A43 A52 - A12 A21 A33 A44 A55 +
    A12 A21 A33 A45 A54 + A12 A21 A34 A43 A55 - A12 A21 A34 A45 A53 - A12 A21 A35 A43 A54 + A12 A21 A35 A44 A53 +
    A12 A23 A31 A44 A55 - A12 A23 A31 A45 A54 - A12 A23 A34 A41 A55 + A12 A23 A34 A45 A51 + A12 A23 A35 A41 A54 -
    A12 A23 A35 A44 A51 - A12 A24 A31 A43 A55 + A12 A24 A31 A45 A53 + A12 A24 A33 A41 A55 - A12 A24 A33 A45 A51 -
    A12 A24 A35 A41 A53 + A12 A24 A35 A43 A51 + A12 A25 A31 A43 A54 - A12 A25 A31 A44 A53 - A12 A25 A33 A41 A54 +
    A12 A25 A33 A44 A51 + A12 A25 A34 A41 A53 - A12 A25 A34 A43 A51 + A13 A21 A32 A44 A55 - A13 A21 A32 A45 A54 -
    A13 A21 A34 A42 A55 + A13 A21 A34 A45 A52 + A13 A21 A35 A42 A54 - A13 A21 A35 A44 A52 - A13 A22 A31 A44 A55 +
    A13 A22 A31 A45 A54 + A13 A22 A34 A41 A55 - A13 A22 A34 A45 A51 - A13 A22 A35 A41 A54 + A13 A22 A35 A44 A51 +
    A13 A24 A31 A42 A55 - A13 A24 A31 A45 A52 - A13 A24 A32 A41 A55 + A13 A24 A32 A45 A51 + A13 A24 A35 A41 A52 -
    A13 A24 A35 A42 A51 - A13 A25 A31 A42 A54 + A13 A25 A31 A44 A52 + A13 A25 A32 A41 A54 - A13 A25 A32 A44 A51 -
    A13 A25 A34 A41 A52 + A13 A25 A34 A42 A51 - A14 A21 A32 A43 A55 + A14 A21 A32 A45 A53 + A14 A21 A33 A42 A55 -
    A14 A21 A33 A45 A52 - A14 A21 A35 A42 A53 + A14 A21 A35 A43 A52 + A14 A22 A31 A43 A55 - A14 A22 A31 A45 A53 -
    A14 A22 A33 A41 A55 + A14 A22 A33 A45 A51 + A14 A22 A35 A41 A53 - A14 A22 A35 A43 A51 - A14 A23 A31 A42 A55 +
    A14 A23 A31 A45 A52 + A14 A23 A32 A41 A55 - A14 A23 A32 A45 A51 - A14 A23 A35 A41 A52 + A14 A23 A35 A42 A51 +
    A14 A25 A31 A42 A53 - A14 A25 A31 A43 A52 - A14 A25 A32 A41 A53 + A14 A25 A32 A43 A51 + A14 A25 A33 A41 A52 -
    A14 A25 A33 A42 A51 + A15 A21 A32 A43 A54 - A15 A21 A32 A44 A53 - A15 A21 A33 A42 A54 + A15 A21 A33 A44 A52 +
    A15 A21 A34 A42 A53 - A15 A21 A34 A43 A52 - A15 A22 A31 A43 A54 + A15 A22 A31 A44 A53 + A15 A22 A33 A41 A54 -
    A15 A22 A33 A44 A51 - A15 A22 A34 A41 A53 + A15 A22 A34 A43 A51 + A15 A23 A31 A42 A54 - A15 A23 A31 A44 A52 -
    A15 A23 A32 A41 A54 + A15 A23 A32 A44 A51 + A15 A23 A34 A41 A52 - A15 A23 A34 A42 A51 - A15 A24 A31 A42 A53 +
    A15 A24 A31 A43 A52 + A15 A24 A32 A41 A53 - A15 A24 A32 A43 A51 - A15 A24 A33 A41 A52 + A15 A24 A33 A42 A51
check(det(A) == B)

"Testing minor"

clear
A = ((A11,A12),(A21,A22))
check(minor(A,1,1) == A22)
check(minor(A,1,2) == A21)
check(minor(A,2,1) == A12)
check(minor(A,2,2) == A11)
A = ((A11,A12,A13),(A21,A22,A23),(A31,A32,A33))
check(minor(A,1,1) == A22 A33 - A23 A32)
check(minor(A,1,2) == A21 A33 - A23 A31)
check(minor(A,1,3) == A21 A32 - A22 A31)
check(minor(A,2,1) == A12 A33 - A13 A32)
check(minor(A,2,2) == A11 A33 - A13 A31)
check(minor(A,2,3) == A11 A32 - A12 A31)
check(minor(A,3,1) == A12 A23 - A13 A22)
check(minor(A,3,2) == A11 A23 - A13 A21)
check(minor(A,3,3) == A11 A22 - A12 A21)

"Testing minormatrix"

A = ((A11,A12),
     (A21,A22))

for(i,1,2,for(j,1,2,check(det(minormatrix(A,i,j)) == minor(A,i,j))))

A = ((A11,A12,A13),
     (A21,A22,A23),
     (A31,A32,A33))

for(i,1,3,for(j,1,3,check(det(minormatrix(A,i,j)) == minor(A,i,j))))

A = ((A11,A12,A13,A14),
     (A21,A22,A23,A24),
     (A31,A32,A33,A34),
     (A41,A42,A43,A44))

for(i,1,4,for(j,1,4,check(det(minormatrix(A,i,j)) == minor(A,i,j))))

A = ((A11,A12,A13,A14,A15),
     (A21,A22,A23,A24,A25),
     (A31,A32,A33,A34,A35),
     (A41,A42,A43,A44,A45),
     (A51,A52,A53,A54,A55))

for(i,1,5,for(j,1,5,check(det(minormatrix(A,i,j)) == minor(A,i,j))))

A = ((A11,A12,A13,A14,A15,A16),
     (A21,A22,A23,A24,A25,A26),
     (A31,A32,A33,A34,A35,A36),
     (A41,A42,A43,A44,A45,A46),
     (A51,A52,A53,A54,A55,A56),
     (A61,A62,A63,A64,A65,A66))

for(i,1,6,for(j,1,6,check(det(minormatrix(A,i,j)) == minor(A,i,j))))

"Testing noexpand"

clear
A = ((a^2 - lambda,0,0),(0,b^2 - lambda,0),(0,0,c^2 - lambda))
B = ((1 / (a^2 - lambda),0,0),(0,1 / (b^2 - lambda),0),(0,0,1 / (c^2 - lambda)))
check(noexpand(inv(A)) == B)
check(noexpand(adj(A)/det(A)) == B)

"Testing local variables"

clear
x = 123 -- global x in use, need local x in P
P(f,n,m,x) = eval(1/(2^n n!) (1 - x^2)^(m/2) d((x^2 - 1)^n,x,n + m),x,f)
check(P(cos(theta),2,0) == 3/2 cos(theta)^2 - 1/2)

"Testing abs"

clear
check(abs(7) == 7)
check(abs(-7) == 7)
check(infixform(abs(x)) == "abs(x)")
check(infixform(abs(-x)) == "abs(x)")
check(abs(3 - 4 i) == 5)
check(abs(r exp(i theta)) == abs(r))
check(abs(cos(5/8 pi)) == -cos(5/8 pi))
check(abs(x y) == abs(x) abs(y))
check(abs(1/x) == 1/abs(x))
check(prefixform(abs(b - a)) == "(abs (+ a (* -1 b)))")

t = abs(2)
check(t = 2)
t = abs(2.0)
check(t = 2)
t = abs(-2)
check(t = 2)
t = abs(-2.0)
check(t = 2)
t = abs(a)
check(t = abs(a))
t = abs(-a)
check(t = abs(a))
t = abs(2*a)
check(t = 2*abs(a))
t = abs(-2*a)
check(t = 2*abs(a))
t = abs(2.0*a)
check(t = 2*abs(a))
t = abs(-2.0*a)
check(t = 2*abs(a))
t = abs(a-b)+abs(b-a)
check(t = 2*abs(a-b))
t = abs(3 + 4 i)
check(t = 5)
t = abs((2,3,4))
check(t = 29^(1/2))
t = abs(a*b)
check(t = abs(a)*abs(b))
t = abs(a/b)
check(t = abs(a)/abs(b))
t = abs(1/a^b)
check(t = 1/(abs(a^b)))

"Testing complex exponentials"

clear

check(rect(exp(1/6 i pi)) == 1/2 (sqrt(3) + i))
check(rect(exp(2/6 i pi)) == 1/2 (1 + sqrt(3) i))

check(rect(exp(4/6 i pi)) == 1/2 (-1 + sqrt(3) i))
check(rect(exp(5/6 i pi)) == 1/2 (-sqrt(3) + i))

check(rect(exp(7/6 i pi)) == 1/2 (-sqrt(3) - i))
check(rect(exp(8/6 i pi)) == 1/2 (-1 - sqrt(3) i))

check(rect(exp(10/6 i pi)) == 1/2 (1 - sqrt(3) i))
check(rect(exp(11/6 i pi)) == 1/2 (sqrt(3) - i))

check(rect(exp(13/6 i pi)) == 1/2 (sqrt(3) + i))
check(rect(exp(14/6 i pi)) == 1/2 (1 + sqrt(3) i))

check(rect(exp(16/6 i pi)) == 1/2 (-1 + sqrt(3) i))
check(rect(exp(17/6 i pi)) == 1/2 (-sqrt(3) + i))

check(rect(exp(19/6 i pi)) == 1/2 (-sqrt(3) - i))
check(rect(exp(20/6 i pi)) == 1/2 (-1 - sqrt(3) i))

check(rect(exp(22/6 i pi)) == 1/2 (1 - sqrt(3) i))
check(rect(exp(23/6 i pi)) == 1/2 (sqrt(3) - i))

check(rect(exp(-1/6 i pi)) == 1/2 (sqrt(3) - i))
check(rect(exp(-2/6 i pi)) == 1/2 (1 - sqrt(3) i))

check(rect(exp(-4/6 i pi)) == 1/2 (-1 - sqrt(3) i))
check(rect(exp(-5/6 i pi)) == 1/2 (-sqrt(3) - i))

check(rect(exp(-7/6 i pi)) == 1/2 (-sqrt(3) + i))
check(rect(exp(-8/6 i pi)) == 1/2 (-1 + sqrt(3) i))

check(rect(exp(-10/6 i pi)) == 1/2 (1 + sqrt(3) i))
check(rect(exp(-11/6 i pi)) == 1/2 (sqrt(3) + i))

check(rect(exp(-13/6 i pi)) == 1/2 (sqrt(3) - i))
check(rect(exp(-14/6 i pi)) == 1/2 (1 - sqrt(3) i))

check(rect(exp(-16/6 i pi)) == 1/2 (-1 - sqrt(3) i))
check(rect(exp(-17/6 i pi)) == 1/2 (-sqrt(3) - i))

check(rect(exp(-19/6 i pi)) == 1/2 (-sqrt(3) + i))
check(rect(exp(-20/6 i pi)) == 1/2 (-1 + sqrt(3) i))

check(rect(exp(-22/6 i pi)) == 1/2 (1 + sqrt(3) i))
check(rect(exp(-23/6 i pi)) == 1/2 (sqrt(3) + i))

check(infixform(exp(0/8 i pi)) == "1")
check(infixform(exp(1/8 i pi)) == "exp(1/8 i pi)")
check(infixform(exp(2/8 i pi)) == "exp(1/4 i pi)")
check(infixform(exp(3/8 i pi)) == "exp(3/8 i pi)")

check(infixform(exp(4/8 i pi)) == "i")
check(infixform(exp(5/8 i pi)) == "i exp(1/8 i pi)")
check(infixform(exp(6/8 i pi)) == "i exp(1/4 i pi)")
check(infixform(exp(7/8 i pi)) == "i exp(3/8 i pi)")

check(infixform(exp(8/8 i pi)) == "-1")
check(infixform(exp(9/8 i pi)) == "-exp(1/8 i pi)")
check(infixform(exp(10/8 i pi)) == "-exp(1/4 i pi)")
check(infixform(exp(11/8 i pi)) == "-exp(3/8 i pi)")

check(infixform(exp(12/8 i pi)) == "-i")
check(infixform(exp(13/8 i pi)) == "-i exp(1/8 i pi)")
check(infixform(exp(14/8 i pi)) == "-i exp(1/4 i pi)")
check(infixform(exp(15/8 i pi)) == "-i exp(3/8 i pi)")

check(infixform(exp(16/8 i pi)) == "1")
check(infixform(exp(17/8 i pi)) == "exp(1/8 i pi)")
check(infixform(exp(18/8 i pi)) == "exp(1/4 i pi)")
check(infixform(exp(19/8 i pi)) == "exp(3/8 i pi)")

check(infixform(exp(20/8 i pi)) == "i")
check(infixform(exp(21/8 i pi)) == "i exp(1/8 i pi)")
check(infixform(exp(22/8 i pi)) == "i exp(1/4 i pi)")
check(infixform(exp(23/8 i pi)) == "i exp(3/8 i pi)")

check(infixform(exp(24/8 i pi)) == "-1")
check(infixform(exp(25/8 i pi)) == "-exp(1/8 i pi)")
check(infixform(exp(26/8 i pi)) == "-exp(1/4 i pi)")
check(infixform(exp(27/8 i pi)) == "-exp(3/8 i pi)")

check(infixform(exp(28/8 i pi)) == "-i")
check(infixform(exp(29/8 i pi)) == "-i exp(1/8 i pi)")
check(infixform(exp(30/8 i pi)) == "-i exp(1/4 i pi)")
check(infixform(exp(31/8 i pi)) == "-i exp(3/8 i pi)")

check(infixform(exp(-0/8 i pi)) == "1")
check(infixform(exp(-1/8 i pi)) == "-i exp(3/8 i pi)")
check(infixform(exp(-2/8 i pi)) == "-i exp(1/4 i pi)")
check(infixform(exp(-3/8 i pi)) == "-i exp(1/8 i pi)")

check(infixform(exp(-4/8 i pi)) == "-i")
check(infixform(exp(-5/8 i pi)) == "-exp(3/8 i pi)")
check(infixform(exp(-6/8 i pi)) == "-exp(1/4 i pi)")
check(infixform(exp(-7/8 i pi)) == "-exp(1/8 i pi)")

check(infixform(exp(-8/8 i pi)) == "-1")
check(infixform(exp(-9/8 i pi)) == "i exp(3/8 i pi)")
check(infixform(exp(-10/8 i pi)) == "i exp(1/4 i pi)")
check(infixform(exp(-11/8 i pi)) == "i exp(1/8 i pi)")

check(infixform(exp(-12/8 i pi)) == "i")
check(infixform(exp(-13/8 i pi)) == "exp(3/8 i pi)")
check(infixform(exp(-14/8 i pi)) == "exp(1/4 i pi)")
check(infixform(exp(-15/8 i pi)) == "exp(1/8 i pi)")

check(infixform(exp(-16/8 i pi)) == "1")
check(infixform(exp(-17/8 i pi)) == "-i exp(3/8 i pi)")
check(infixform(exp(-18/8 i pi)) == "-i exp(1/4 i pi)")
check(infixform(exp(-19/8 i pi)) == "-i exp(1/8 i pi)")

check(infixform(exp(-20/8 i pi)) == "-i")
check(infixform(exp(-21/8 i pi)) == "-exp(3/8 i pi)")
check(infixform(exp(-22/8 i pi)) == "-exp(1/4 i pi)")
check(infixform(exp(-23/8 i pi)) == "-exp(1/8 i pi)")

check(infixform(exp(-24/8 i pi)) == "-1")
check(infixform(exp(-25/8 i pi)) == "i exp(3/8 i pi)")
check(infixform(exp(-26/8 i pi)) == "i exp(1/4 i pi)")
check(infixform(exp(-27/8 i pi)) == "i exp(1/8 i pi)")

check(infixform(exp(-28/8 i pi)) == "i")
check(infixform(exp(-29/8 i pi)) == "exp(3/8 i pi)")
check(infixform(exp(-30/8 i pi)) == "exp(1/4 i pi)")
check(infixform(exp(-31/8 i pi)) == "exp(1/8 i pi)")

check(exp(0/8.0 i pi) == 1)
check(exp(1/8.0 i pi) == exp(1/8 i pi))
check(exp(2/8.0 i pi) == exp(1/4 i pi))
check(exp(3/8.0 i pi) == exp(3/8 i pi))

check(exp(4/8.0 i pi) == i)
check(exp(5/8.0 i pi) == i exp(1/8 i pi))
check(exp(6/8.0 i pi) == i exp(1/4 i pi))
check(exp(7/8.0 i pi) == i exp(3/8 i pi))

check(exp(8/8.0 i pi) == -1)
check(exp(9/8.0 i pi) == -exp(1/8 i pi))
check(exp(10/8.0 i pi) == -exp(1/4 i pi))
check(exp(11/8.0 i pi) == -exp(3/8 i pi))

check(exp(12/8.0 i pi) == -i)
check(exp(13/8.0 i pi) == -i exp(1/8 i pi))
check(exp(14/8.0 i pi) == -i exp(1/4 i pi))
check(exp(15/8.0 i pi) == -i exp(3/8 i pi))

check(exp(16/8.0 i pi) == 1)
check(exp(17/8.0 i pi) == exp(1/8 i pi))
check(exp(18/8.0 i pi) == exp(1/4 i pi))
check(exp(19/8.0 i pi) == exp(3/8 i pi))

check(exp(20/8.0 i pi) == i)
check(exp(21/8.0 i pi) == i exp(1/8 i pi))
check(exp(22/8.0 i pi) == i exp(1/4 i pi))
check(exp(23/8.0 i pi) == i exp(3/8 i pi))

check(exp(24/8.0 i pi) == -1)
check(exp(25/8.0 i pi) == -exp(1/8 i pi))
check(exp(26/8.0 i pi) == -exp(1/4 i pi))
check(exp(27/8.0 i pi) == -exp(3/8 i pi))

check(exp(28/8.0 i pi) == -i)
check(exp(29/8.0 i pi) == -i exp(1/8 i pi))
check(exp(30/8.0 i pi) == -i exp(1/4 i pi))
check(exp(31/8.0 i pi) == -i exp(3/8 i pi))

check(exp(-0/8.0 i pi) == 1)
check(exp(-1/8.0 i pi) == -i exp(3/8 i pi))
check(exp(-2/8.0 i pi) == -i exp(1/4 i pi))
check(exp(-3/8.0 i pi) == -i exp(1/8 i pi))

check(exp(-4/8.0 i pi) == -i)
check(exp(-5/8.0 i pi) == -exp(3/8 i pi))
check(exp(-6/8.0 i pi) == -exp(1/4 i pi))
check(exp(-7/8.0 i pi) == -exp(1/8 i pi))

check(exp(-8/8.0 i pi) == -1)
check(exp(-9/8.0 i pi) == i exp(3/8 i pi))
check(exp(-10/8.0 i pi) == i exp(1/4 i pi))
check(exp(-11/8.0 i pi) == i exp(1/8 i pi))

check(exp(-12/8.0 i pi) == i)
check(exp(-13/8.0 i pi) == exp(3/8 i pi))
check(exp(-14/8.0 i pi) == exp(1/4 i pi))
check(exp(-15/8.0 i pi) == exp(1/8 i pi))

check(exp(-16/8.0 i pi) == 1)
check(exp(-17/8.0 i pi) == -i exp(3/8 i pi))
check(exp(-18/8.0 i pi) == -i exp(1/4 i pi))
check(exp(-19/8.0 i pi) == -i exp(1/8 i pi))

check(exp(-20/8.0 i pi) == -i)
check(exp(-21/8.0 i pi) == -exp(3/8 i pi))
check(exp(-22/8.0 i pi) == -exp(1/4 i pi))
check(exp(-23/8.0 i pi) == -exp(1/8 i pi))

check(exp(-24/8.0 i pi) == -1)
check(exp(-25/8.0 i pi) == i exp(3/8 i pi))
check(exp(-26/8.0 i pi) == i exp(1/4 i pi))
check(exp(-27/8.0 i pi) == i exp(1/8 i pi))

check(exp(-28/8.0 i pi) == i)
check(exp(-29/8.0 i pi) == exp(3/8 i pi))
check(exp(-30/8.0 i pi) == exp(1/4 i pi))
check(exp(-31/8.0 i pi) == exp(1/8 i pi))

"Testing bug fixes"

clear
check(i exp(1/4 i pi) exp(1/4 i pi) == -1)
check(i exp(1/8 i pi) == exp(5/8 i pi))
check(infixform(cos(1/3.0 pi)) == "0.5")
check(infixform(sin(1/6.0 pi)) == "0.5")
check(infixform(polar(2.0 + 3.0 i)) == "3.60555 exp(0.312833 i pi)")
check(infixform(exp(0.5 i pi)) == "i") -- was 1.0 i
check(infixform(arg(1.0 i)) == "1.5708") -- was 1/2 pi
check(infixform(log(1.0 i)) == "1.5708 i") -- was 1/2 i pi
check(infixform(1/abs(2.0+3.0i)) == "0.27735")
check(infixform(1/arg(2.0+3.0i)) == "1.01751")
check(infixform(1/mag(2.0+3.0i)) == "0.27735")
check((1/3)^x == 3^(-x))
check(i^x == (-1)^(x/2))
check((-2/3)^x == 2^x 3^(-x) (-1)^x)
check(infixform((-2/3)^1.2) == "-0.497334 - 0.361334 i")
check((-192)^x == 2^(6 x) 3^x (-1)^x)

"Testing arg"

check(arg(2 + 3 i) == arg(polar(2 + 3 i)))
check(arg(2 - 3 i) == arg(polar(2 - 3 i)))
check(arg(-2 + 3 i) == arg(polar(-2 + 3 i)))
check(arg(-2 - 3 i) == arg(polar(-2 - 3 i)))

check(arg(2 + 3 i) == arg(clock(2 + 3 i)))
check(arg(2 - 3 i) == arg(clock(2 - 3 i)))
check(arg(-2 + 3 i) == arg(clock(-2 + 3 i)))
check(arg(-2 - 3 i) == arg(clock(-2 - 3 i)))

-- use prefixform to compare floating point numbers

check(prefixform(arg(2.0 + 3.0 i)) == prefixform(arg(polar(2.0 + 3.0 i))))
check(prefixform(arg(2.0 - 3.0 i)) == prefixform(arg(polar(2.0 - 3.0 i))))
check(prefixform(arg(-2.0 + 3.0 i)) == prefixform(arg(polar(-2.0 + 3.0 i))))
check(prefixform(arg(-2.0 - 3.0 i)) == prefixform(arg(polar(-2.0 - 3.0 i))))

check(prefixform(arg(2.0 + 3.0 i)) == prefixform(arg(clock(2.0 + 3.0 i))))
check(prefixform(arg(2.0 - 3.0 i)) == prefixform(arg(clock(2.0 - 3.0 i))))
check(prefixform(arg(-2.0 + 3.0 i)) == prefixform(arg(clock(-2.0 + 3.0 i))))
check(prefixform(arg(-2.0 - 3.0 i)) == prefixform(arg(clock(-2.0 - 3.0 i))))

"Testing infixform"

check(infixform(1/x) == "1 / x")
check(infixform(x^2) == "x^2")
check(infixform(x^(-2)) == "1 / x^2")
check(infixform(sin(x)^2) == "sin(x)^2")
check(infixform(3^x) == "3^x")
check(infixform((-3)^x) == "3^x (-1)^x")
check(infixform((1/3)^x) == "3^(-x)")
check(infixform((-1/3)^x) == "3^(-x) (-1)^x")
check(infixform(1.2^x) == "1.2^x")
check(infixform((1.2 10^9)^x) == "(1.2 10^9)^x")
check(infixform((1.2 10^(-9))^x) == "(1.2 10^(-9))^x")
check(infixform((a+b)^x) == "(a + b)^x")
check(infixform((a+b)/(c+d)) == "a / (c + d) + b / (c + d)")
check(infixform(2/3 x/y) == "2 x / (3 y)")
check(infixform(-2/3 x/y) == "-2 x / (3 y)")
check(infixform((a,b,c)) == "(a,b,c)")
check(infixform(((a,b),(c,d))) == "((a,b),(c,d))")
check(infixform(quote((a+b)/(c+d))) == "(a + b) / (c + d)")
check(infixform(x^(a+b)) == "x^(a + b)")
check(infixform(x^(a b)) == "x^(a b)")
check(infixform(x^(a^b)) == "x^(a^b)")
check(infixform(x^(n!)) == "x^(n!)")
check(infixform(x^sin(x)) == "x^sin(x)")

"Testing hadamard"

clear
X = (a,b,c)
check(hadamard(X,X) == (a^2,b^2,c^2))
A = (A1,A2)
B = (B1,B2)
check(A B == (A1 B1, A2 B2))
check(0 A B == (0,0))

-- done

clear
trace = 0
status
"ok"
exit
